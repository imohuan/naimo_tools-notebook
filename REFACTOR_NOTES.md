# Markdown 编辑器重构说明

## 重构日期

2025 年 10 月 16 日

## 重构原因

原有的自定义块级编辑器存在以下问题：

1. **代码复杂度高** - 自行实现了大量编辑器逻辑（超过 1000 行代码）
2. **功能有限** - 相比专业编辑器缺少很多功能
3. **维护成本高** - 需要处理大量边界情况和交互细节
4. **用户体验不够完善** - 缺少专业编辑器的交互体验

## 重构方案

使用 [Vditor](https://b3log.org/vditor/) 专业的 Markdown 编辑器库进行重构。

### Vditor 优势

- ✅ **功能完善** - 支持所有 Markdown 语法
- ✅ **即时渲染** - IR（即时渲染）模式，所见即所得
- ✅ **用户体验优秀** - 专业的编辑器交互
- ✅ **维护良好** - 活跃的社区支持
- ✅ **代码精简** - 从 1000+ 行缩减到 200 行

## 主要改动

### 1. 依赖变更

**移除：**

- `highlight.js` - Vditor 内置代码高亮
- `marked` - Vditor 内置 Markdown 解析

**新增：**

- `vditor` ^3.10.7

### 2. 组件简化

**原实现：**

- `BlockEditor.vue` (400+ 行) - 复杂的块管理逻辑
- `EditorBlock.vue` (1150+ 行) - 自定义的块编辑器
- `CommandMenu.vue` - 命令菜单
- `CopyButton.vue` - 复制按钮
- 复杂的状态管理和事件处理

**新实现：**

- `BlockEditor.vue` (200 行) - 简洁的 Vditor 封装
- 移除了所有自定义块组件

### 3. 核心功能对比

| 功能          | 原实现         | 新实现 (Vditor) |
| ------------- | -------------- | --------------- |
| Markdown 语法 | 基础支持       | 完整支持        |
| 代码高亮      | highlight.js   | 内置高亮        |
| 即时渲染      | 手动实现       | IR 模式         |
| 工具栏        | 自定义命令菜单 | 完整工具栏      |
| 快捷键        | 部分支持       | 完整支持        |
| 表格编辑      | 不支持         | ✅ 支持         |
| 图片上传      | 不支持         | ✅ 支持         |
| 数学公式      | 不支持         | ✅ 支持         |
| 流程图        | 不支持         | ✅ 支持         |
| 字数统计      | 不支持         | ✅ 支持         |
| 大纲视图      | 不支持         | ✅ 支持         |
| 全屏模式      | 不支持         | ✅ 支持         |

## 使用方式

### 编辑模式

Vditor 提供三种编辑模式（当前使用 IR 模式）：

- **IR (Instant Rendering)** - 即时渲染，所见即所得
- **WYSIWYG** - 富文本编辑模式
- **SV (Split View)** - 分屏预览模式

可通过工具栏切换编辑模式。

### 工具栏功能

- 📝 文本格式：加粗、斜体、删除线
- 📋 标题、引用、列表
- 💻 代码块、行内代码
- 🔗 链接、表格
- ↩️ 撤销、重做
- 👁️ 预览、大纲、全屏

### 快捷键

- `Ctrl/Cmd + B` - 加粗
- `Ctrl/Cmd + I` - 斜体
- `Ctrl/Cmd + K` - 插入链接
- `Ctrl/Cmd + Z` - 撤销
- `Ctrl/Cmd + Shift + Z` - 重做
- 更多快捷键见 [Vditor 文档](https://b3log.org/vditor/)

## 性能优化

1. **内容防抖保存** - 500ms 防抖，减少保存频率
2. **失焦立即保存** - 编辑器失焦时立即保存，防止内容丢失
3. **实例复用** - 切换笔记时复用编辑器实例
4. **内存管理** - 组件销毁时正确清理定时器和编辑器实例

## 向后兼容

- ✅ 完全兼容原有的 Markdown 格式
- ✅ 保留相同的保存接口
- ✅ 保持相同的标题提取逻辑

## 未来改进

- [ ] 支持图片拖拽上传
- [ ] 支持导出 PDF
- [ ] 支持主题切换
- [ ] 支持自定义工具栏

## 参考资料

- [Vditor 官网](https://b3log.org/vditor/)
- [Vditor GitHub](https://github.com/Vanessa219/vditor)
- [Vditor Vue 3 示例](https://b3log.org/vditor/demo/vue.html)
